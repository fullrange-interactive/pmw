!function(a){"use strict";a.pmw=a.pmw||{},a.pmw.mconfig={name:"pmw",serverUrl:"http://bill.pimp-my-wall.ch",instagramId:"1a2703a38f69498abc57f7175a38d8d2",webappUrl:"http://pimp-my-wall.ch/webapp/",routes:{"":"postPhotoController"},contestServerPostUrl:"http://bob.pimp-my-wall.ch/post.php",contestServerStatusUrl:"http://bob.pimp-my-wall.ch/status.php"}}(this);var fakeLocalStorage=function(){var a,b={};window.Storage&&window.localStorage?a=window.Storage.prototype:(window.localStorage={},a=window.localStorage),window.location.origin||(window.location.origin=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""));var c=function(b,c){var d=null==b?null:a.getItem(b),e=location.href.substr(location.origin.length),f=document.createEvent("StorageEvent");f.initStorageEvent("storage",!1,!1,b,d,c,e,null),window.dispatchEvent(f)};a.key=function(a){var c=Object.keys(b)[a];return"string"==typeof c?c:null},a.getItem=function(a){return"string"==typeof b[a]?b[a]:null},a.setItem=function(a,d){c(a,d),b[a]=String(d)},a.removeItem=function(a){c(a,null),delete b[a]},a.clear=function(){c(null,null),b={}}};if("object"==typeof window.localStorage)try{localStorage.setItem("localStorageTest",1),localStorage.removeItem("localStorageTest")}catch(e){fakeLocalStorage()}else fakeLocalStorage();var backRoute;!function(a){"use strict";a.pmw=M.Application.extend().create(a.pmw.mconfig),$(document).ready(function(){var b=a.location.href.split("#");b.length>1&&(a.location.href=b[0],docCookies.setItem("after-anchor",b[1])),a.pmw.selectedWindowGroup=localStorage.getItem("selectedWindowGroup"),a.pmw.start({routing:{routes:a.pmw.options.routes,postPhotoController:a.pmw.Controllers.PostPhotoController.create()}})})}(this),this.JST=this.JST||{},pmw.Views=pmw.Views||{},function(){"use strict";pmw.Views.BackheaderView=M.ToolbarView.extend({scopeKey:"pageHeadline"},{first:M.ButtonView.extend({icon:"fa-angle-left",events:{tap:function(){pmw.navigate({route:backRoute,transition:M.PageTransitions.CONST.MOVE_TO_RIGHT_FROM_LEFT})}}}),second:M.View.extend({useElement:YES,template:'<div class="logo"><img src="images/Logo.png" /></div>'})})}(),pmw.Views=pmw.Views||{},function(){"use strict";pmw.Views.PostPhotoView=M.View.extend({cssClass:"page-post-photo",template:'<div id="fb-root"></div>'},{help:M.View.extend({cssClass:"post-photo-help"},{conditionsButton:M.ButtonView.extend({icon:"fa-question-circle",cssClass:"conditions mini",value:"Conditions de participation",events:{tap:"showConditions"}})}),area:M.View.extend({cssClass:"post-photo-canvas-wrapper"},{canvas:M.View.extend({useElement:YES,template:'<canvas id="post-photo-canvas"></canvas>'}),sendButton:M.ButtonView.extend({icon:"fa-rocket",value:"Envoyer!",cssClass:"send",events:{tap:"sendPhoto"}}),cancelButton:M.ButtonView.extend({icon:"fa-undo",cssClass:"undo",events:{tap:"cancelPhoto"}})}),fakeArea:M.View.extend({cssClass:"post-photo-fake-wrapper"},{canvas:M.View.extend({useElement:YES,template:'<img id="post-photo-fake"/>'}),sendButton:M.ButtonView.extend({icon:"fa-rocket",value:"Envoyer!",cssClass:"send",events:{tap:"sendPhoto"}}),cancelButton:M.ButtonView.extend({icon:"fa-undo",cssClass:"undo",events:{tap:"cancelPhoto"}})}),takePhoto:M.ButtonView.extend({icon:"fa-camera",cssClass:"camera"}),participateForm:M.View.extend({cssClass:"participate-form modal-window"},{close:M.ButtonView.extend({icon:"fa-times",cssClass:"close-modal-window alt-color",events:{tap:"closeParticipate"}}),helpGeneral:M.TextView.extend({value:'Veuillez remplir tous les champs. En participant, vous acceptez les <a href="#">conditions de participation</a>.',grid:"col-xs-12",cssClass:"general-description",events:{tap:"showConditions"}}),firstName:M.TextfieldView.extend({label:"Prénom:",grid:"col-xs-12",id:"first-name",type:"text",regexp:/(.+)/,events:{keyup:"checkField"}}),lastName:M.TextfieldView.extend({label:"Nom:",grid:"col-xs-12",id:"last-name",type:"text",regexp:/(.+)/,events:{keyup:"checkField"}}),phone:M.TextfieldView.extend({label:"N° de téléphone:",grid:"col-xs-12",id:"phone",type:"text",regexp:/[0-9\+\.\-\(\) ]{10,}/i,events:{keyup:"checkField"}}),email:M.TextfieldView.extend({label:"Adresse e-mail:",grid:"col-xs-12",id:"email",type:"something",regexp:/.+@.+\..+/i,events:{keyup:"checkField"}}),helpSocial:M.TextView.extend({grid:"col-xs-12",value:"Choisissez un réseau social pour participer:"}),submitFacebook:M.ButtonView.extend({icon:"fa-facebook",grid:"col-xs-6",cssClass:"post-social facebook",value:"Facebook",events:{tap:"participateFacebook"}}),submitInstagram:M.ButtonView.extend({icon:"fa-instagram",grid:"col-xs-6",cssClass:"post-social instagram",value:"Instagram",events:{tap:"participateInstagram"}})}),modalContainer:M.View.extend({cssClass:"modal-alert-container"},{modalWindow:M.View.extend({cssClass:"modal-alert-window"},{text:M.View.extend({cssClass:"modal-alert-text"}),okButton:M.ButtonView.extend({value:"OK",cssClass:"ok-button",events:{tap:"closeModalAlert"}})})}),conditionsText:M.View.extend({cssClass:"conditions-text modal-window"},{conditionsCloseButton:M.ButtonView.extend({icon:"fa-times",cssClass:"close-modal-window alt-color all-on-top",events:{tap:"closeConditions"}}),conditionsIFrame:M.View.extend({useElement:YES,template:'<div class="iframe-holder"><iframe src="html/privacy.html"></iframe></div>'})}),shareInstagram:M.View.extend({cssClass:"share-instagram modal-window"},{close:M.ButtonView.extend({icon:"fa-times",cssClass:"close-modal-window alt-color",events:{tap:"closeInstagram"}}),photo:M.ImageView.extend({cssClass:"user-photo-big",value:"images/selfie-example.jpg"}),explanation:M.View.extend({useElement:YES,template:"<ol><li>Sauvegardez cette image <a href='#' class='save-picture-help'><i class='fa fa-question-circle'></i></a></li><li>Ouvrez Instagram</li><li>Publiez votre selfie, <strong>n'oubliez pas le hashtag #mybcvs!</strong></li></ol>"}),screenshot:M.View.extend({cssClass:"screenshot-container"},{photo:M.ImageView.extend({cssClass:"user-photo",value:"images/selfie-example.jpg"}),overlay:M.ImageView.extend({cssClass:"overlay",value:"images/instagram-ios.png"})}),openInstagram:M.ButtonView.extend({icon:"fa-instagram",cssClass:"instagram open-instagram",value:"Ouvrir Instagram",events:{tap:"openInstagramApp"}})}),disabler:M.View.extend({cssClass:"disabler"},{content:M.View.extend({cssClass:"disabler-content",value:"Le concours de selfie est fermé pour l'instant. Les horaires sont les suivants: <ul><li>lu-ma: 17:00 &mdash; 20:00</li><li>me: 13:00 &mdash; 20:00</li><li>je-ve: 17:00 &mdash; 20:00</li><li>sa-di: 11:00 &mdash; 20:00</li></ul>"})})})}(),pmw.Controllers=pmw.Controllers||{},function(){"use strict";pmw.Controllers.AbstractController=M.Controller.extend({headerView:null,contentView:null,menuView:null,pageHeadline:"",applicationStart:function(a){var b=M.SwitchHeaderContentLayout.extend({}).create(this,null,!0);pmw.setLayout(b),this._initViews(a)},show:function(a){this._initViews(a);var b=M.SwitchHeaderContentLayout.extend({}).create(this,null,!0);b._type===pmw.getLayout()._type?pmw.getLayout().startTransition():this.applicationStart()},applicationReady:function(){},_applyViews:function(){pmw.getLayout().applyViews({header:this.headerView,content:this.contentView})},_initViews:function(){}})}(),pmw.Controllers=pmw.Controllers||{},function(a){"use strict";function b(a,b){function c(a){var b=(a.naturalWidth,a.naturalHeight),c=document.createElement("canvas");c.width=1,c.height=b;var d=c.getContext("2d");d.drawImage(a,0,0);for(var e=d.getImageData(0,0,1,b).data,f=0,g=b,h=b;h>f;){var i=e[4*(h-1)+3];0===i?g=h:f=h,h=g+f>>1}var j=h/b;return 0===j?1:j}var d=c(b),e=arguments.length;switch(e){case 4:a.drawImage(b,arguments[2],arguments[3]/d);break;case 6:a.drawImage(b,arguments[2],arguments[3],arguments[4],arguments[5]/d);break;case 8:a.drawImage(b,arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7]/d);break;case 10:a.drawImage(b,arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7],arguments[8],arguments[9]/d)}}var c=null,d=null,e=640,f=640,g=30,h=5,i=50,j=null,k=null,l=null,m=!1,n=null,o=!1,p=function(){if(navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(Windows Phone (OS 7|8.0))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/))return!1;var a=document.createElement("input");return a.type="file",!a.disabled},q=function(){return"undefined"==typeof a.FormData?!1:!0},r=function(){var b=new MobileDetect(window.navigator.userAgent);return"HTC"==b.phone()?(console.log("HTC piece of shit, disabling file reader."),!1):"undefined"==typeof a.FileReader?!1:!0},s=function(a,b,c){b?$(".ok-button").hide():$(".ok-button").show(),$(".modal-alert-text").html(a),$(".modal-alert-container").addClass("shown"),c?$(".ok-button .button").bind("tap",function(){c(),$(".ok-button .button").unbind("tap")}):($(".ok-button .button").unbind("tap"),$(".ok-button .button").bind("tap",function(){$(".modal-alert-container").removeClass("shown")}))},t=function(){var a=new MobileDetect(window.navigator.userAgent);return a.os()};pmw.Controllers.PostPhotoController=pmw.Controllers.AbstractController.extend({pageHeadline:"Choisis un truc",loader:null,ctx:null,fbLoggedIn:!1,_initViews:function(){if(t(),!q()||!p())return void alert("Malheureusement votre téléphone n'est pas assez récent et n'est pas compatible avec notre application.");this.contentView||(this.contentView=pmw.Views.PostPhotoView.create(this,null,!0)),this.headerView||(this.headerView=M.ToolbarView.extend({grid:"col-md-12",value:"myBCVS"}).create()),this._applyViews(),$(".page-post-photo .camera").prepend('<input type="file" accept="image/*" id="photo-file-input" >'),$(".page-post-photo #photo-file-input").on("change",this.gotPhoto.bind(this)),d=$("#post-photo-canvas").get()[0].getContext("2d"),d.canvas.width=e,d.canvas.height=f,window.addEventListener("resize",this.resizeCanvas.bind(this),!1),window.addEventListener("orientationchange",this.resizeCanvas.bind(this),!1),this.resizeCanvas();var b=this;if($("#loading-splash-screen").remove(),docCookies.hasItem("instagram-post")){var g=docCookies.getItem("after-anchor");if(null==g)s("Pour participer, vous devez autoriser notre application à se connecter à Instagram!");else{var h=g.match(/^access_token=(.+?)$/);if(h.length<2)return void s("Une erreur s'est produite lors de la connexion. Merci de ressayer.");l=h[1],k="instagram"}$("#first-name input").val(docCookies.getItem("first-name")),$("#last-name input").val(docCookies.getItem("last-name")),$("#email input").val(docCookies.getItem("email")),$("#phone input").val(docCookies.getItem("phone")),n=docCookies.getItem("photo-url"),this.showParticipate(),docCookies.removeAll(),c=M.LoaderView.create().render().show(),this.postParticipate()}a.fbAsyncInit=function(){FB.init({appId:"1381340082121397",xfbml:!0,version:"v2.4"}),FB.getLoginStatus(function(a){b.fbLoggedIn="connected"==a.status})},$(".save-picture-help").on("click tap",function(){s("Pour sauvegarder la photo: <ol class='text-left'><li>Laissez votre doigt appuyé longtemps sur la photo</li><li>Choisissez l'option 'Enregistrer l'image'</li></ol>")}),this.checkDisabler()},resizeCanvas:function(){console.log("resize");var a=e/f,b=window.innerHeight?window.innerHeight:$(window).height(),c=$(window).width(),d=0,j=0,k=$(".toolbarview").height();b-=k,1>c/b?(d=c-2*g,j=d*a):(j=b-2*g,d=j/a);var l=$("#post-photo-fake");l.width(d),l.height(j);var m=-j/2-h/2;b/2+j/2>b-i-2*g&&(m-=b/2+j/2-(b-i-3.5*g)),-20>b/2+m&&(m=-j/2-h/2),l.css("margin-left",-d/2-h/2+"px"),l.css("margin-top",m+"px"),l=$("#post-photo-canvas"),l.width(d),l.height(j);var m=-j/2-h/2;b/2+j/2>b-i-2*g&&(m-=b/2+j/2-(b-i-3.5*g)),-20>b/2+m&&(m=-j/2-h/2),l.css("margin-left",-d/2-h/2+"px"),l.css("margin-top",m+"px")},gotPhoto:function(){var b=$("#photo-file-input").get()[0];if(!b.files||0==b.files.length)return void s("Vous devez prendre une photo ou choisir une image pour participer.");if(r()){var d=new a.FileReader;d.onabort=this.abort,d.onerror=this.error,d.onload=this.readPhotoDone,d.readAsDataURL(b.files[0]),c=M.LoaderView.create().render().show()}else{var e=new FormData,f=this;c=M.LoaderView.create().render().show(),e.append("file",b.files[0]),$.ajax({url:a.pmw.options.serverUrl+"/postPhoto",type:"post",data:e,processData:!1,contentType:!1,responseType:"json"}).done(function(b){b=JSON.parse(b),b.error&&s(b.error),c.hide(),m=!0;var d=(a.pmw.options.serverUrl+"/"+b.src.replace("public/",""),{result:a.pmw.options.serverUrl+"/"+b.src.replace("public/","")});f.readPhotoDone.call(d,{})}).fail(function(){c&&c.hide(),s("Une erreur s'est produite<br/>(connexion au serveur impossible)<br/>Mais ce n'est pas de votre faute! Veuillez ressayer plus tard.")})}},readPhotoDone:function(a,g){var h=new Image;h.onload=function(){null!=c&&c.hide(),g||EXIF.getData(h,function(){var a=EXIF.getTag(h,"Orientation");if(navigator.userAgent.match(/Windows Phone/i))switch(a){case 2:d.translate(e,0),d.scale(-1,1);break;case 3:d.translate(e,f),d.rotate(Math.PI);break;case 4:d.translate(0,f),d.scale(1,-1);break;case 5:d.rotate(-.5*Math.PI),d.scale(1,-1);break;case 6:d.rotate(-.5*Math.PI),d.translate(0,-f);break;case 7:d.rotate(-.5*Math.PI),d.translate(e,-f),d.scale(-1,1);break;case 8:d.rotate(.5*Math.PI),d.translate(-e,0)}else switch(a){case 2:d.translate(e,0),d.scale(-1,1);break;case 3:d.translate(e,f),d.rotate(Math.PI);break;case 4:d.translate(0,f),d.scale(1,-1);break;case 5:d.rotate(.5*Math.PI),d.scale(1,-1);break;case 6:d.rotate(.5*Math.PI),d.translate(0,-f);break;case 7:d.rotate(.5*Math.PI),d.translate(e,-f),d.scale(-1,1);break;case 8:d.rotate(-.5*Math.PI),d.translate(-e,0)}});var a=h.width,i=h.height,j=0,k=0;if(a>i?(j=(a-i)/2,a=i):(k=(i-a)/2,i=a),$(".post-photo-help").hide(),$(".page-post-photo .camera").hide(),console.log("photoUploaded = "+m),m)return $(".post-photo-fake-wrapper").show(),void $(".post-photo-fake-wrapper img").attr("src",this.src);$(".post-photo-canvas-wrapper").show(),b(d,this,j,k,a,i,0,0,e,f);var l=new Image;l.onload=function(){d.setTransform(1,0,0,1,0,0),d.drawImage(this,0,0,e,f,0,0,e,f),c.hide()},l.src="images/overlay-3.png"},h.src=this.result},checkAllFields:function(){var a=!0;a&=this.internalCheckField(this.contentView.childViews.participateForm.childViews.lastName),a&=this.internalCheckField(this.contentView.childViews.participateForm.childViews.firstName),a&=this.internalCheckField(this.contentView.childViews.participateForm.childViews.phone),a&=this.internalCheckField(this.contentView.childViews.participateForm.childViews.email),a?(this.contentView.childViews.participateForm.childViews.submitFacebook.enable(),this.contentView.childViews.participateForm.childViews.submitInstagram.enable()):(this.contentView.childViews.participateForm.childViews.submitFacebook.disable(),this.contentView.childViews.participateForm.childViews.submitInstagram.disable())},checkField:function(a,b){13==a.which&&(0!=b.$el.next().find("input").length?b.$el.next().find("input").focus():(b.$el.find("input").blur(),console.log("blur "+b.$el.find("input")))),b.usedOnce=!0,this.checkAllFields()},internalCheckField:function(a){return a.getValue().trim().match(a.regexp)?(a.$el.removeClass("wrong"),!0):(a.usedOnce&&a.$el.addClass("wrong"),!1)},sendPhoto:function(){var b=this;if(m)this.showParticipate();else{var e=d.canvas.toDataURL("image/jpeg",1),f="jpeg";-1!=e.substring(0,30).indexOf("image/png")&&(f="png"),c=M.LoaderView.create().render().show(),$.post(a.pmw.options.serverUrl+"/postPhoto",{base64Image:e,imageFormat:f},function(d){return null!=c&&c.hide(),d.error?void s(d.error):(n=a.pmw.options.serverUrl+"/"+d.src.replace("public/",""),void b.showParticipate())},"json").fail(function(){null!=c&&c.hide(),s("Une erreur s'est produite ... mais ce n'est pas de votre faute! Veuillez ressayer plus tard.")})}},participateFacebook:function(){var b=this;c=M.LoaderView.create().render().show(),this.fbLoggedIn?b.getFacebookData(b.postParticipate.bind(b)):a.FB.login(function(a){a.authResponse?b.getFacebookData(b.postParticipate.bind(b)):(s("Pour participer, vous devez autoriser notre application à se connecter à Facebook!"),c.hide())},{enable_profile_selector:!0,scope:"public_profile"})},getFacebookData:function(a){FB.api("/me?fields=first_name,last_name,email",function(b){j=b.id,k="facebook",a()})},participateInstagram:function(){docCookies.setItem("instagram-post",!0),docCookies.setItem("first-name",$("#first-name input").val()),docCookies.setItem("last-name",$("#last-name input").val()),docCookies.setItem("phone",$("#phone input").val()),docCookies.setItem("email",$("#email input").val()),docCookies.setItem("photo-url",n),window.location.replace("https://instagram.com/oauth/authorize/?client_id="+a.pmw.options.instagramId+"&redirect_uri="+encodeURIComponent(a.pmw.options.webappUrl)+"&response_type=token")},postParticipate:function(){var b=this,d={firstName:$("#first-name input").val(),lastName:$("#last-name input").val(),phone:$("#phone input").val(),email:$("#email input").val(),imageUrl:n};"facebook"==k?(d.accountId=j,d.accountType="Facebook"):(d.accountType="Instagram",d.token=l),$.post(a.pmw.options.contestServerPostUrl,d,function(a){"facebook"==k?(b.checkModerated(a.internalId),c.hide(),s("Votre photo doit encore être validée par notre équipe. Veuillez patentier...<br /><i class='fa fa-spinner fa-spin'></i>",!0)):(c.hide(),b.finishInstagram())}).fail(function(){b.finishInstagram()})},checkModerated:function(b){var c=this;$.get(a.pmw.options.contestServerStatusUrl,{id:b},function(a){1==a.moderated?s("Votre photo a été acceptée.<br><br>Pour gagner, partagez-la sur votre mur en appuyant sur OK",!1,c.finishFacebook.bind(c,a)):-1==a.moderated?s("Votre photo a été refusée!"):setTimeout(c.checkModerated.bind(c,b),1e3)})},finishFacebook:function(b){var c=this;a.FB.ui({method:"share",href:b.postedUrl,type:"touch"},function(){c.closeParticipate(),s("Merci pour votre participation!<br><br>Encouragez vos amis à liker votre photo pour avoir plus de chances de gagner!",!1,function(){window.location.reload()})})},finishInstagram:function(){$(".share-instagram .user-photo-big img").attr("src",n);var a=t();"AndroidOS"==a?($(".share-instagram .screenshot-container .overlay img").attr("src","images/instagram-android.png"),$(".screenshot-container").addClass("android")):"WindowsPhoneOS"==a?($(".share-instagram .screenshot-container .overlay img").attr("src","images/instagram-windows-phone.png"),$(".screenshot-container").addClass("windows-phone")):($(".share-instagram .screenshot-container .overlay img").attr("src","images/instagram-ios.png"),$(".screenshot-container").addClass("ios")),$(".share-instagram .screenshot-container .user-photo img").attr("src",n),$(".share-instagram").addClass("shown"),this.closeParticipate(),c&&c.hide()},cancelPhoto:function(){confirm("Voulez-vous vraiment refaire votre selfie?")&&($(".post-photo-help").show(),$(".post-photo-canvas-wrapper").hide(),$(".post-photo-fake-wrapper").hide(),$(".page-post-photo .camera").show())},abort:function(){s("Opération annulée.")},error:function(a){null!=c&&c.hide(),s("Il y a eu une erreur, merci d'essayer plus tard. Erreur: "+a)},checkDisabler:function(){var b=this;$.get(a.pmw.options.contestServerStatusUrl,{status:1},function(a){a.status?this.hideDisabler():this.showDisabler()}.bind(this)),setTimeout(this.checkDisabler.bind(b),3e4)},showParticipate:function(){$(".participate-form").addClass("shown"),$(".send").hide(),this.checkAllFields(),o=!0},closeParticipate:function(a){$(".participate-form").removeClass("shown"),$(".send").show(),a||(o=!1)},showConditions:function(){this.closeParticipate(!0),$(".conditions-text").addClass("shown")},closeConditions:function(){o&&this.showParticipate(),$(".conditions-text").removeClass("shown")},closeModalAlert:function(){$(".modal-alert-container").removeClass("shown")},closeInstagram:function(){$(".share-instagram").removeClass("shown")},openInstagramApp:function(){window.location.replace("instagram://camera")},showDisabler:function(){$(".disabler").show()},hideDisabler:function(){$(".disabler").hide()}})}(this);