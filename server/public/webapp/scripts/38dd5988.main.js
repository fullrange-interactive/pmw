!function(a){"use strict";a.pmw=a.pmw||{},a.pmw.mconfig={name:"pmw",serverUrl:"http://bill.pimp-my-wall.ch",liveDrawingUrl:"ws://bill.pimp-my-wall.ch:8080",liveDrawingPreviewId:"307",instagramId:"1a2703a38f69498abc57f7175a38d8d2",webappUrl:"http://pimp-my-wall.ch/webapp/",routes:{"":"postPhotoController"},contestServerPostUrl:"http://bob.pimp-my-wall.ch/post.php",contestServerStatusUrl:"http://bob.pimp-my-wall.ch/status.php"}}(this);var fakeLocalStorage=function(){var a,b={};window.Storage&&window.localStorage?a=window.Storage.prototype:(window.localStorage={},a=window.localStorage),window.location.origin||(window.location.origin=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""));var c=function(b,c){var d=null==b?null:a.getItem(b),e=location.href.substr(location.origin.length),f=document.createEvent("StorageEvent");f.initStorageEvent("storage",!1,!1,b,d,c,e,null),window.dispatchEvent(f)};a.key=function(a){var c=Object.keys(b)[a];return"string"==typeof c?c:null},a.getItem=function(a){return"string"==typeof b[a]?b[a]:null},a.setItem=function(a,d){c(a,d),b[a]=String(d)},a.removeItem=function(a){c(a,null),delete b[a]},a.clear=function(){c(null,null),b={}}};if("object"==typeof window.localStorage)try{localStorage.setItem("localStorageTest",1),localStorage.removeItem("localStorageTest")}catch(e){fakeLocalStorage()}else fakeLocalStorage();var backRoute;!function(a){"use strict";a.pmw=M.Application.extend().create(a.pmw.mconfig),$(document).ready(function(){var b=a.location.href.split("#");b.length>1&&(a.location.href=b[0],docCookies.setItem("after-anchor",b[1])),a.pmw.selectedWindowGroup=localStorage.getItem("selectedWindowGroup"),a.pmw.start({routing:{routes:a.pmw.options.routes,postPhotoController:a.pmw.Controllers.PostPhotoController.create()}})})}(this),this.JST=this.JST||{},pmw.Models=pmw.Models||{},function(){"use strict";pmw.Models.TmpviewModel=M.Model.extend({})}(),pmw.Collections=pmw.Collections||{},function(){"use strict";pmw.Collections.TmpviewsCollection=M.Collection.extend({model:pmw.Models.TmpviewModel})}(),pmw.Views=pmw.Views||{},function(){"use strict";pmw.Views.BackheaderView=M.ToolbarView.extend({scopeKey:"pageHeadline"},{first:M.ButtonView.extend({icon:"fa-angle-left",events:{tap:function(){pmw.navigate({route:backRoute,transition:M.PageTransitions.CONST.MOVE_TO_RIGHT_FROM_LEFT})}}}),second:M.View.extend({useElement:YES,template:'<div class="logo"><img src="images/Logo.png" /></div>'})})}(),pmw.Views=pmw.Views||{},function(){"use strict";pmw.Views.HomeView=M.View.extend({grid:"row"},{tower:M.ImageView.extend({grid:"col-xs-6",cssClass:"col-sm-4 col-md-3 text-center app-icon",value:"images/tower.png",events:{tap:function(){this.setLocationAndChooseFeature("53562d9d3d45fe516a96d161")}}}),entrance:M.ImageView.extend({grid:"col-xs-6",cssClass:"col-sm-4 col-md-3 text-center app-icon",value:"images/entrance.png",events:{tap:function(){this.setLocationAndChooseFeature("53562d9d3d45fe516a96d161")}}}),mainStage:M.ImageView.extend({grid:"col-xs-6",cssClass:"col-sm-4 col-md-3 text-center app-icon",value:"images/main-stage.png",events:{tap:function(){this.setLocationAndChooseFeature("53562d9d3d45fe516a96d161")}}}),interior:M.ImageView.extend({grid:"col-xs-6",cssClass:"col-sm-4 col-md-3 text-center app-icon",value:"images/cafeteria.png",events:{tap:function(){this.setLocationAndChooseFeature("53562d9d3d45fe516a96d161")}}})})}(),pmw.Views=pmw.Views||{},function(){"use strict";pmw.Views.PostPhotoView=M.View.extend({cssClass:"page-post-photo",template:'<div id="fb-root"></div>'},{help:M.View.extend({cssClass:"post-photo-help"},{conditionsButton:M.ButtonView.extend({icon:"fa-question-circle",cssClass:"conditions mini",value:"Conditions de participation",events:{tap:"showConditions"}})}),area:M.View.extend({cssClass:"post-photo-canvas-wrapper"},{canvas:M.View.extend({useElement:YES,template:'<canvas id="post-photo-canvas"></canvas>'}),sendButton:M.ButtonView.extend({icon:"fa-rocket",value:"Envoyer!",cssClass:"send",events:{tap:"sendPhoto"}})}),takePhoto:M.ButtonView.extend({icon:"fa-camera",cssClass:"camera"}),conditionsText:M.View.extend({cssClass:"conditions-text modal-window"},{conditionsCloseButton:M.ButtonView.extend({icon:"fa-times",cssClass:"close-modal-window alt-color",events:{tap:"closeConditions"}}),conditionsIFrame:M.View.extend({useElement:YES,template:'<div class="iframe-holder"><iframe src="html/privacy.html"></iframe></div>'})}),participateForm:M.View.extend({cssClass:"participate-form modal-window"},{close:M.ButtonView.extend({icon:"fa-times",cssClass:"close-modal-window alt-color",events:{tap:"closeParticipate"}}),helpGeneral:M.TextView.extend({value:"Veuillez remplir tous les champs. Ceci nous permettra de vous contacter si vous gagnez!",grid:"col-xs-12",cssClass:"general-description"}),firstName:M.TextfieldView.extend({label:"Prénom:",grid:"col-xs-12",id:"first-name",type:"text",placeholder:"John",regexp:/(.+)/,events:{keyup:"checkField"}}),lastName:M.TextfieldView.extend({label:"Nom:",grid:"col-xs-12",id:"last-name",type:"text",placeholder:"Smith",regexp:/(.+)/,events:{keyup:"checkField"}}),phone:M.TextfieldView.extend({label:"N° de téléphone:",grid:"col-xs-12",id:"phone",placeholder:"079 123 4567",type:"text",regexp:/[0-9\+\.\-\(\) ]{10,}/i,events:{keyup:"checkField"}}),email:M.TextfieldView.extend({label:"Adresse e-mail:",grid:"col-xs-12",id:"email",type:"something",placeholder:"john.smith@example.org",regexp:/.+@.+\..+/i,events:{keyup:"checkField"}}),helpSocial:M.TextView.extend({grid:"col-xs-12",value:"Choisissez un réseau social pour participer:"}),submitFacebook:M.ButtonView.extend({icon:"fa-facebook",grid:"col-xs-6",cssClass:"post-social facebook",value:"Facebook",events:{tap:"participateFacebook"}}),submitInstagram:M.ButtonView.extend({icon:"fa-instagram",grid:"col-xs-6",cssClass:"post-social instagram",value:"Instagram",events:{tap:"participateInstagram"}})}),modalContainer:M.View.extend({cssClass:"modal-alert-container"},{modalWindow:M.View.extend({cssClass:"modal-alert-window"},{text:M.View.extend({cssClass:"modal-alert-text"}),okButton:M.ButtonView.extend({value:"OK",cssClass:"ok-button",events:{tap:"closeModalAlert"}})})}),shareInstagram:M.View.extend({cssClass:"share-instagram modal-window"},{close:M.ButtonView.extend({icon:"fa-times",cssClass:"close-modal-window alt-color",events:{tap:"closeInstagram"}}),photo:M.ImageView.extend({cssClass:"user-photo-big",value:"images/selfie-example.jpg"}),explanation:M.View.extend({useElement:YES,template:"<ol><li>Sauvegardez cette image</li><li>Ouvrez Instagram</li><li>Publiez votre selfie, <strong>n'oubliez pas le hashtag #mybcvs!</strong></li></ol>"}),screenshot:M.View.extend({cssClass:"screenshot-container"},{photo:M.ImageView.extend({cssClass:"user-photo",value:"images/selfie-example.jpg"}),overlay:M.ImageView.extend({cssClass:"overlay",value:"images/instagram-ios.png"})}),openInstagram:M.ButtonView.extend({icon:"fa-instagram",cssClass:"instagram open-instagram",value:"Ouvrir Instagram",events:{tap:"openInstagramApp"}})})})}(),pmw.Controllers=pmw.Controllers||{},function(){"use strict";pmw.Controllers.AbstractController=M.Controller.extend({headerView:null,contentView:null,menuView:null,pageHeadline:"",applicationStart:function(a){var b=M.SwitchHeaderContentLayout.extend({}).create(this,null,!0);pmw.setLayout(b),this._initViews(a)},show:function(a){this._initViews(a);var b=M.SwitchHeaderContentLayout.extend({}).create(this,null,!0);b._type===pmw.getLayout()._type?pmw.getLayout().startTransition():this.applicationStart()},applicationReady:function(){},_applyViews:function(){pmw.getLayout().applyViews({header:this.headerView,content:this.contentView})},_initViews:function(){}})}(),pmw.Controllers=pmw.Controllers||{},function(a){"use strict";pmw.Controllers.MenuController=pmw.Controllers.AbstractController.extend({tmpViews:null,_initViews:function(){this.contentView||(this.contentView=pmw.Views.HomeView.create(this,null,!0)),this.headerView||(this.headerView=M.ToolbarView.extend({grid:"col-md-12",value:"Pimp My Wall"}).create()),this._applyViews()},setLocationAndChooseFeature:function(b){a.pmw.selectedWindowGroup=b,localStorage.setItem("selectedWindowGroup",b),pmw.navigate({route:"/chooseFeature"})}})}(this),pmw.Controllers=pmw.Controllers||{},function(a){"use strict";var b=null,c=null,d=640,e=640,f=30,g=5,h=50,i=null,j=null,k=null,l=!1,m=null,n=function(){return"undefined"==typeof a.FormData?!1:!0},o=function(){return"undefined"==typeof a.FileReader?!1:!0},p=function(a,b,c){b?$(".ok-button").hide():$(".ok-button").show(),$(".modal-alert-text").html(a),$(".modal-alert-container").addClass("shown"),c?$(".ok-button .button").bind("tap",function(){c(),$(".ok-button .button").unbind("tap")}):($(".ok-button .button").unbind("tap"),$(".ok-button .button").bind("tap",function(){$(".modal-alert-container").removeClass("shown")}))};pmw.Controllers.PostPhotoController=pmw.Controllers.AbstractController.extend({pageHeadline:"Choisis un truc",loader:null,ctx:null,fbLoggedIn:!1,_initViews:function(){if(!n())return void alert("Malheureusement votre téléphone est trop vieux et n'est pas compatible avec notre application.");this.contentView||(this.contentView=pmw.Views.PostPhotoView.create(this,null,!0)),this.headerView||(this.headerView=M.ToolbarView.extend({grid:"col-md-12",value:"myBCVS"}).create()),this._applyViews(),$(".page-post-photo .camera").prepend('<input type="file" capture="camera" accept="image/*" id="photo-file-input" >'),$(".page-post-photo #photo-file-input").on("change",this.gotPhoto.bind(this)),c=$("#post-photo-canvas").get()[0].getContext("2d"),c.canvas.width=d,c.canvas.height=e,window.addEventListener("resize",this.resizeCanvas.bind(this),!1),window.addEventListener("orientationchange",this.resizeCanvas.bind(this),!1),this.resizeCanvas();var f=this;if($("#loading-splash-screen").remove(),docCookies.hasItem("instagram-post")){var g=docCookies.getItem("after-anchor");if(null==g)p("Pour participer, vous devez autoriser notre application à se connecter à Instagram!");else{var h=g.match(/^access_token=(.+?)$/);if(h.length<2)return void p("Une erreur s'est produite lors de la connexion. Merci de ressayer.");k=h[1],j="instagram"}$("#first-name input").val(docCookies.getItem("first-name")),$("#last-name input").val(docCookies.getItem("last-name")),$("#email input").val(docCookies.getItem("email")),$("#phone input").val(docCookies.getItem("phone")),m=docCookies.getItem("photo-url"),this.showParticipate(),docCookies.removeAll(),b=M.LoaderView.create().render().show(),this.postParticipate()}a.fbAsyncInit=function(){FB.init({appId:"1381340082121397",xfbml:!0,version:"v2.4"}),FB.getLoginStatus(function(a){f.fbLoggedIn="connected"==a.status})}},resizeCanvas:function(){var a=d/e,b=window.innerHeight?window.innerHeight:$(window).height(),c=$(window).width(),i=0,j=0,k=$(".toolbarview").height();b-=k,1>c/b?(i=c-2*f,j=i*a):(j=b-2*f,i=j/a);var l=$("#post-photo-canvas");l.width(i),l.height(j);var m=-j/2-g/2;b/2+j/2>b-h-2*f&&(m-=b/2+j/2-(b-h-3.5*f)),-20>b/2+m&&(m=-j/2-g/2),l.css("margin-left",-i/2-g/2+"px"),l.css("margin-top",m+"px")},gotPhoto:function(){var c=$("#photo-file-input").get()[0];if(!c.files||0==c.files.length)return void p("Vous devez prendre une photo ou choisir une image pour participer.");if(o()){var d=new a.FileReader;d.onabort=this.abort,d.onerror=this.error,d.onload=this.readPhotoDone,d.readAsDataURL(c.files[0]),b=M.LoaderView.create().render().show()}else{var e=new FormData,f=this;b=M.LoaderView.create().render().show(),e.append("file",c.files[0]),$.ajax({url:a.pmw.options.serverUrl+"/postPhoto",type:"post",data:e,processData:!1,contentType:!1,responseType:"json"}).done(function(c){c=JSON.parse(c),c.error&&p(c.error),b.hide(),l=!0;var d=(a.pmw.options.serverUrl+"/"+c.src.replace("public/",""),{result:a.pmw.options.serverUrl+"/"+c.src.replace("public/","")});f.readPhotoDone.call(d,{})}).fail(function(){b&&b.hide(),p("Une erreur s'est produite ... mais ce n'est pas de votre faute! Veuillez ressayer plus tard.")})}},readPhotoDone:function(a,f){var g=new Image;g.onload=function(){null!=b&&b.hide(),f||EXIF.getData(g,function(){var a=EXIF.getTag(g,"Orientation");switch(a){case 2:c.translate(d,0),c.scale(-1,1);break;case 3:c.translate(d,e),c.rotate(Math.PI);break;case 4:c.translate(0,e),c.scale(1,-1);break;case 5:c.rotate(.5*Math.PI),c.scale(1,-1);break;case 6:c.rotate(.5*Math.PI),c.translate(0,-e);break;case 7:c.rotate(.5*Math.PI),c.translate(d,-e),c.scale(-1,1);break;case 8:c.rotate(-.5*Math.PI),c.translate(-d,0)}});var a=g.width,h=g.height,i=0,j=0;a>h?(i=(a-h)/2,a=h):(j=(h-a)/2,h=a),$(".post-photo-help").hide(),$(".post-photo-canvas-wrapper").show(),$(".page-post-photo .camera").hide(),c.drawImage(this,i,j,a,h,0,0,d,e);var k=new Image;k.onload=function(){c.drawImage(this,0,0,d,e,0,0,d,e),b.hide()},k.src="images/overlay.png"},g.src=this.result},checkAllFields:function(){var a=!0;a&=this.internalCheckField(this.contentView.childViews.participateForm.childViews.lastName),a&=this.internalCheckField(this.contentView.childViews.participateForm.childViews.firstName),a&=this.internalCheckField(this.contentView.childViews.participateForm.childViews.phone),a&=this.internalCheckField(this.contentView.childViews.participateForm.childViews.email),a?(this.contentView.childViews.participateForm.childViews.submitFacebook.enable(),this.contentView.childViews.participateForm.childViews.submitInstagram.enable()):(this.contentView.childViews.participateForm.childViews.submitFacebook.disable(),this.contentView.childViews.participateForm.childViews.submitInstagram.disable())},checkField:function(a,b){13==a.which&&b.$el.next().find("input").focus(),b.usedOnce=!0,this.checkAllFields()},internalCheckField:function(a){return a.getValue().trim().match(a.regexp)?(a.$el.removeClass("wrong"),!0):(a.usedOnce&&a.$el.addClass("wrong"),!1)},showParticipate:function(){$(".participate-form").addClass("shown"),$(".send").hide(),this.checkAllFields()},closeParticipate:function(){$(".participate-form").removeClass("shown"),$(".send").show()},sendPhoto:function(){var d=this;if(l)this.showParticipate();else{var e=c.canvas.toDataURL("image/jpeg",1),f="jpeg";-1!=e.substring(0,30).indexOf("image/png")&&(f="png"),b=M.LoaderView.create().render().show(),$.post(a.pmw.options.serverUrl+"/postPhoto",{base64Image:e,imageFormat:f},function(c){return null!=b&&b.hide(),c.error?void p(c.error):(m=a.pmw.options.serverUrl+"/"+c.src.replace("public/",""),void d.showParticipate())},"json").fail(function(){null!=b&&b.hide(),p("Une erreur s'est produite ... mais ce n'est pas de votre faute! Veuillez ressayer plus tard.")})}},participateFacebook:function(){var c=this;b=M.LoaderView.create().render().show(),this.fbLoggedIn?c.getFacebookData(c.postParticipate.bind(c)):a.FB.login(function(a){a.authResponse?c.getFacebookData(c.postParticipate.bind(c)):(p("Pour participer, vous devez autoriser notre application à se connecter à Facebook!"),b.hide())},{enable_profile_selector:!0,scope:"public_profile"})},getFacebookData:function(a){FB.api("/me?fields=first_name,last_name,email",function(b){i=b.id,j="facebook",a()})},participateInstagram:function(){docCookies.setItem("instagram-post",!0),docCookies.setItem("first-name",$("#first-name input").val()),docCookies.setItem("last-name",$("#last-name input").val()),docCookies.setItem("phone",$("#phone input").val()),docCookies.setItem("email",$("#email input").val()),docCookies.setItem("photo-url",m),window.location.replace("https://instagram.com/oauth/authorize/?client_id="+a.pmw.options.instagramId+"&redirect_uri="+encodeURIComponent(a.pmw.options.webappUrl)+"&response_type=token")},postParticipate:function(){var c=this,d={firstName:$("#first-name input").val(),lastName:$("#last-name input").val(),phone:$("#phone input").val(),email:$("#email input").val(),imageUrl:m};"facebook"==j?(d.accountId=i,d.accountType="Facebook"):(d.accountType="Instagram",d.token=k),$.post(a.pmw.options.contestServerPostUrl,d,function(a){"facebook"==j?(c.checkModerated(a.internalId),b.hide(),p("Votre photo doit encore être validée par notre équipe. Veuillez patentier...<br /><i class='fa fa-spinner fa-spin'></i>",!0)):(b.hide(),c.finishInstagram())}).fail(function(){c.finishInstagram()})},checkModerated:function(b){var c=this;$.get(a.pmw.options.contestServerStatusUrl,{id:b},function(a){1==a.moderated?p("Votre photo a été acceptée.<br><br>Pour gagner, partagez-la sur votre mur en appuyant sur OK",!1,c.finishFacebook.bind(c,a)):-1==a.moderated?p("Votre photo a été refusée!"):setTimeout(c.checkModerated.bind(c,b),1e3)})},finishFacebook:function(b){var c=this;a.FB.ui({method:"share",href:b.postedUrl,type:"touch"},function(){c.closeParticipate(),p("Merci pour votre participation!<br><br>Encouragez vos amis à liker votre photo pour avoir plus de chances de gagner!",!1,function(){window.location.reload()})})},finishInstagram:function(){$(".share-instagram .user-photo-big img").attr("src",m),$(".share-instagram .screenshot-container .user-photo img").attr("src",m),$(".share-instagram").addClass("shown"),this.closeParticipate(),b&&b.hide()},abort:function(){p("Opération annulée.")},error:function(a){p("Il y a eu une erreur, merci d'essayer plus tard. Erreur: "+a)},showConditions:function(){$(".conditions-text").addClass("shown")},closeConditions:function(){$(".conditions-text").removeClass("shown")},closeModalAlert:function(){$(".modal-alert-container").removeClass("shown")},closeInstagram:function(){$(".share-instagram").removeClass("shown")},openInstagramApp:function(){window.location.replace("instagram://camera")}})}(this);