/*global pmw, $*/pmw.Controllers = pmw.Controllers || {};(function(global) {    'use strict';    var loading = 0;    var atLeastOneLoading = false;    var galImages = [];    var showNotifNewPicture = false;    global.pmw.intervalHandleGallery = null;        pmw.Controllers.GalleryController = pmw.Controllers.AbstractController.extend({        pageHeadline: "Clique sur l'image à dédicacer!",        photographer: false,        constructor: function(photographer) {            this.photographer = photographer;        },        _initViews: function() {            // backRoute = "#chooseFeature";            // Create the ContentView with the controller (this) as scope            if (!this.contentView) {                this.contentView = pmw.Views.GalleryView.create(this, null, true);            }            // Create the HeaderView with the controller (this) as scope            if (!this.headerView) {                this.headerView = M.ToolbarView.extend({                    grid: 'col-md-12',                    value: 'Choisis une photo à dédicacer'                }).create();            }            this._applyViews();            if(global.pmw.intervalHandleGallery === null) {                galImages = [];                global.pmw.intervalHandleGallery =  window.setInterval(this.updateGallery.bind(this), 2000);                this.updateGallery();            }             window.addEventListener('resize', this.resizeCanvas, false);            window.addEventListener('orientationchange', this.resizeCanvas, false);            $('.content-wrapper').scroll(this.scrollCheck);        },        updateGallery: function ()        {            $.get(global.pmw.options.serverUrl + "/gallery/", {                listImages: 1            }, function(data) {                this.fillGallery(data);            }.bind(this), 'json');        },        scrollCheck:function ()        {            // console.log($('.content-wrapper').scrollTop());            if(showNotifNewPicture && $('.content-wrapper').scrollTop() == 0)            {                $("#show-notif").remove();                showNotifNewPicture = false;            }        },        /* Prepend new images to img-gallery */        fillGallery: function(images) {            // Check for deleted images            images = images.sort();            for (var i = galImages.length - 1; i >= 0; i--)            {                if (images.indexOf(galImages[i]) === -1){                    console.log("Not found " + galImages[i]);                    // A photo was deleted!                    var toDelete = $(".img[data-path='" + galImages[i] + "']");                    if (toDelete.length !== 0) {                        var top = toDelete.offset().top;                        var height = toDelete.outerHeight();                        var scrollTop = $('.content-wrapper').scrollTop();                        if (top + height < 0) {                            $(".content-wrapper").scrollTop(scrollTop - height);                        }                        toDelete.remove();                    }                    galImages.splice(i, 1);                }            }            // Check for new images            for (var i = 0; i < images.length; i++)            {                if(galImages.indexOf(images[i]) === -1)                {                    loading++;                    if(loading > 0 && atLeastOneLoading === false)                    {                        $('.content-wrapper').append('<div id="show-loading"><p>Chargement des images...</p></div>');                        atLeastOneLoading = true;                    }                                        var img = $(new Image());                                        galImages.push(images[i]);                    img.on('load',function(url, controller)                    {                        loading--;                        // console.log(loading);                        if(loading == 0)                        {                            // console.log( $("#show-loading"));                            $("#show-loading").remove();                        }                        this.attr('width',"100%");                        var markup = $('<div class="img"></div>');                        markup.attr("data-path", url);                        markup.append(this);                        if (controller.photographer) {                            var deleteButton = $('<div class="delete">X</div>');                            deleteButton.on("tap click", function (imgUrl, markup, e) {                                if (confirm("Effacer la photo?") === true) {                                    $.get(global.pmw.options.serverUrl + "/gallery/", {                                        deleteImage: imgUrl                                     }, function(data) {                                        if (data === "OK") {                                            markup.remove();                                        }                                    }.bind(this));                                }                            }.bind(deleteButton, url, markup));                            markup.append(deleteButton);                        }                        $("#img-gallery").prepend(markup);                        if($('.content-wrapper').scrollTop()!=0)                        {                            $('.content-wrapper').scrollTop($('.content-wrapper').scrollTop() + this[0].clientHeight);                            if(!showNotifNewPicture)                            {                                $('.content-wrapper').append('<div id="show-notif"><p>Des nouvelles images sont disponibles. Clique ici pour remonter !</p></div>');                                $('#show-notif').on('tap click',function(){                                    $('.content-wrapper').scrollTop(0);                                });                                showNotifNewPicture = true;                            }                        }                    }.bind(img, images[i], this));                    img.on("tap click", function(controller, e) {                        e.preventDefault();                        global.pmw.selectedGalImage = this.attr("data-path");                        global.pmw.photographer = controller.photographer;                        clearInterval(global.pmw.intervalHandleGallery);                        global.pmw.intervalHandleGallery = null;                        // console.log(this.attr("data-basename"));                        pmw.navigate({                            route: '#dedicacePhoto'                        });                    }.bind(img, this));                    img.attr('data-path', images[i]);                    img.attr('src', global.pmw.options.serverUrl + images[i]);                }            }        }    });})(this);